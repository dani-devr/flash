<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Cases - Tuti Gambling Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Rajdhani:wght@600;700&display=swap');

        :root {
            --primary: #f59e0b;
            --bg-dark: #050505;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, .brand-font {
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
        }

        /* --- Components --- */
        .case-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: radial-gradient(circle at center, #1a1a1a, #000);
            border: 1px solid #333;
        }
        .case-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -5px rgba(245, 158, 11, 0.1);
            border-color: var(--primary);
        }

        /* Spinner */
        .spinner-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 180px; 
            margin: 0 auto;
            overflow: hidden;
            background: #080808;
            border-radius: 12px;
            border: 1px solid #333;
            box-shadow: inset 0 0 60px rgba(0,0,0,1);
        }
        .spinner-overlay-left, .spinner-overlay-right {
            position: absolute; top: 0; bottom: 0; width: 100px; z-index: 5; pointer-events: none;
        }
        .spinner-overlay-left { left: 0; background: linear-gradient(to right, #050505 0%, transparent 100%); }
        .spinner-overlay-right { right: 0; background: linear-gradient(to left, #050505 0%, transparent 100%); }
        .center-line {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #eab308; z-index: 10;
            transform: translateX(-50%); box-shadow: 0 0 15px #eab308;
        }
        .items-strip { display: flex; height: 100%; align-items: center; will-change: transform; }

        /* Battle Spinner specific */
        .battle-spinner { height: 140px; border: 1px solid #222; }
        .battle-spinner .w-\[150px\] { width: 110px; }
        .battle-spinner .h-\[180px\] { height: 120px; }

        /* Items */
        .weapon-img { filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8)); transition: transform 0.3s ease; }
        .item-card-base:hover .weapon-img { transform: scale(1.1) rotate(-2deg); }

        /* JACKPOT WHEEL */
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: #111;
            border: 8px solid #222;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .wheel-spinner {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            transition: transform 5s cubic-bezier(0.1, 0, 0.05, 1);
            transform: rotate(0deg);
        }

        .wheel-inner {
            position: absolute;
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: #050505;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .wheel-arrow {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; 
            height: 0; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #fff;
            z-index: 20;
            filter: drop-shadow(0 0 10px #fff);
        }

        /* MINES */
        .mine-tile {
            transition: all 0.2s;
            cursor: pointer;
        }
        .mine-tile:hover { background-color: #27272a; }
        .mine-tile.revealed { cursor: default; }

        /* BLACKJACK */
        .playing-card {
            width: 80px; height: 112px; background: white; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: space-between; padding: 4px;
            font-weight: bold; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: dealCard 0.4s ease-out forwards;
            opacity: 0; transform: translateY(-20px) scale(0.8);
        }
        @keyframes dealCard { to { opacity: 1; transform: translateY(0) scale(1); } }
        .suit-red { color: #ef4444; } .suit-black { color: #1e293b; }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; }

        /* Rarity Colors */
        .rarity-consumer { border-color: #747474; --glow: #747474; }
        .rarity-mil-spec { border-color: #2b60b5; --glow: #2b60b5; }
        .rarity-restricted { border-color: #6a3cbd; --glow: #6a3cbd; }
        .rarity-classified { border-color: #b026c4; --glow: #b026c4; }
        .rarity-covert { border-color: #cc2323; --glow: #cc2323; }
        .rarity-gold { border-color: #e8b80e; --glow: #e8b80e; }

        .glow-text { text-shadow: 0 0 10px var(--glow); color: var(--glow); }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes popIn { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #f59e0b; }
        .toggle-checkbox:checked + .toggle-label { background-color: #f59e0b; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

    <nav class="bg-black/80 backdrop-blur border-b border-white/10 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-8">
                    <div onclick="router.navigate('home')" class="flex items-center gap-2 cursor-pointer group">
                        <div class="bg-amber-500/10 p-2 rounded-lg group-hover:bg-amber-500/20 transition">
                            <i data-lucide="zap" class="text-amber-500 w-6 h-6 group-hover:scale-110 transition-transform"></i>
                        </div>
                        <span class="text-2xl font-bold brand-font text-white tracking-wide">Flash<span class="text-amber-500">Cases</span></span>
                    </div>
                    <div class="hidden md:flex items-center gap-1 bg-white/5 p-1 rounded-lg border border-white/5">
                        <button onclick="router.navigate('home')" class="px-4 py-2 rounded-md text-sm font-bold transition hover:bg-white/10 hover:text-white text-slate-300">Cases</button>
                        <button onclick="router.navigate('minigames')" class="px-4 py-2 rounded-md text-sm font-bold transition hover:bg-white/10 hover:text-white text-slate-300 text-amber-500">Minigames</button>
                        <button onclick="router.navigate('upgrader')" class="px-4 py-2 rounded-md text-sm font-bold transition hover:bg-white/10 hover:text-white text-slate-300">Upgrader</button>
                        <button onclick="router.navigate('inventory')" class="px-4 py-2 rounded-md text-sm font-bold transition hover:bg-white/10 hover:text-white text-slate-300">Inventory</button>
                    </div>
                </div>
                <div id="auth-section" class="flex items-center gap-4"></div>
            </div>
        </div>
    </nav>

    <main id="app-root" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[80vh]"></main>

    <div id="login-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/95 backdrop-blur-sm">
        <div class="bg-zinc-900 p-8 rounded-2xl border border-zinc-800 w-full max-w-md shadow-2xl pop-in relative">
            <h2 class="text-3xl font-bold brand-font mb-2 text-white">Login</h2>
            <form onsubmit="auth.login(event)">
                <div class="space-y-4">
                    <input type="text" id="login-user" class="w-full bg-black border border-zinc-700 rounded-lg p-4 focus:border-amber-500 outline-none text-white font-bold" placeholder="Username" required>
                    <input type="password" id="login-pass" class="w-full bg-black border border-zinc-700 rounded-lg p-4 focus:border-amber-500 outline-none text-white font-bold" placeholder="Password" required>
                    <button type="submit" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-black uppercase tracking-wider py-4 rounded-lg transition mt-2">Login</button>
                </div>
            </form>
            <div class="mt-4 text-center">
                <span class="text-slate-500 text-sm">No account? </span>
                <button onclick="ui.closeModal('login-modal'); ui.openModal('register-modal')" class="text-amber-500 font-bold hover:underline text-sm">Register</button>
            </div>
            <button onclick="ui.closeModal('login-modal')" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
        </div>
    </div>

    <div id="register-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/95 backdrop-blur-sm">
        <div class="bg-zinc-900 p-8 rounded-2xl border border-zinc-800 w-full max-w-md shadow-2xl pop-in relative">
            <h2 class="text-3xl font-bold brand-font mb-2 text-white">Create Account</h2>
            <form onsubmit="auth.register(event)">
                <div class="space-y-4">
                    <input type="email" id="reg-email" class="w-full bg-black border border-zinc-700 rounded-lg p-4 focus:border-amber-500 outline-none text-white font-bold" placeholder="Email" required>
                    <input type="text" id="reg-user" maxlength="15" class="w-full bg-black border border-zinc-700 rounded-lg p-4 focus:border-amber-500 outline-none text-white font-bold" placeholder="Username" required>
                    <input type="password" id="reg-pass" class="w-full bg-black border border-zinc-700 rounded-lg p-4 focus:border-amber-500 outline-none text-white font-bold" placeholder="Password" required>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black uppercase tracking-wider py-4 rounded-lg transition mt-2">Register</button>
                </div>
            </form>
            <div class="mt-4 text-center">
                <span class="text-slate-500 text-sm">Have an account? </span>
                <button onclick="ui.closeModal('register-modal'); ui.openModal('login-modal')" class="text-amber-500 font-bold hover:underline text-sm">Login</button>
            </div>
            <button onclick="ui.closeModal('register-modal')" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
        </div>
    </div>

    <div id="deposit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/95 backdrop-blur-sm">
        <div class="bg-zinc-900 p-8 rounded-2xl border border-zinc-800 w-full max-w-md shadow-2xl pop-in relative">
            <h2 class="text-3xl font-bold brand-font mb-4 text-white">DEPOSIT</h2>
            
            <div class="flex gap-2 mb-6 p-1 bg-black rounded-lg">
                <button onclick="ui.setDepositTab('card')" id="tab-card" class="flex-1 py-2 rounded text-sm font-bold bg-zinc-800 text-white transition">Card</button>
                <button onclick="ui.setDepositTab('pix')" id="tab-pix" class="flex-1 py-2 rounded text-sm font-bold text-slate-500 hover:text-white transition">Pix</button>
            </div>

            <div id="view-card" class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Amount</label>
                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg px-4 py-3 mt-1">
                        <span class="text-emerald-500 mr-2">$</span>
                        <input type="number" id="dep-amount" value="100" class="bg-transparent text-white font-bold w-full outline-none">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Card Number (Roleplay)</label>
                    <input type="text" id="dep-cc" placeholder="0000 0000 0000 0000" maxlength="19" class="w-full bg-black border border-zinc-700 rounded-lg p-3 mt-1 text-white font-mono">
                </div>
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label class="text-xs text-slate-400 uppercase font-bold">Expiry</label>
                        <input type="text" placeholder="MM/YY" maxlength="5" class="w-full bg-black border border-zinc-700 rounded-lg p-3 mt-1 text-white font-mono">
                    </div>
                    <div class="w-1/2">
                        <label class="text-xs text-slate-400 uppercase font-bold">CVV</label>
                        <input type="text" placeholder="123" maxlength="3" class="w-full bg-black border border-zinc-700 rounded-lg p-3 mt-1 text-white font-mono">
                    </div>
                </div>
                <button onclick="server.processDeposit()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black uppercase tracking-wider py-4 rounded-lg transition mt-6">PAY NOW</button>
            </div>

            <div id="view-pix" class="space-y-4 hidden">
                <div id="pix-input-step">
                    <label class="text-xs text-slate-400 uppercase font-bold">Amount</label>
                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg px-4 py-3 mt-1">
                        <span class="text-emerald-500 mr-2">$</span>
                        <input type="number" id="pix-amount" value="50" class="bg-transparent text-white font-bold w-full outline-none">
                    </div>
                    <button onclick="server.generatePix()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black uppercase tracking-wider py-4 rounded-lg transition mt-6">GENERATE QR CODE</button>
                </div>
                <div id="pix-qr-step" class="hidden text-center">
                    <div class="bg-white p-4 rounded-lg inline-block mb-4 mx-auto">
                        <img id="pix-qr-img" src="" class="w-48 h-48 mx-auto" alt="QR Code">
                    </div>
                    <p class="text-sm text-slate-400 mb-2">Scan or Copy Code</p>
                    <div class="bg-black p-3 rounded border border-zinc-700 font-mono text-xs text-slate-300 break-all mb-4 cursor-pointer hover:text-white" onclick="alert('Copied to clipboard!')">
                        00020126360014BR.GOV.BCB.PIX0114+551199999999520400005303986540510.005802BR5913FLASHCASES6008SAOPAULO62070503***6304E2CA
                    </div>
                    <button onclick="server.confirmPix()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition" id="btn-pix-confirm">I HAVE PAID</button>
                </div>
            </div>

            <button onclick="ui.closeModal('deposit-modal')" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
        </div>
    </div>

    <div id="withdraw-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/95 backdrop-blur-sm">
        <div class="bg-zinc-900 p-8 rounded-2xl border border-zinc-800 w-full max-w-md shadow-2xl pop-in relative text-center">
            <div class="mx-auto bg-emerald-500/10 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="landmark" class="w-8 h-8 text-emerald-500"></i>
            </div>
            <h2 class="text-3xl font-bold brand-font mb-2 text-white">WITHDRAW</h2>
            <p class="text-slate-500 mb-6">Transferring funds to your fake bank account...</p>
            
            <div class="bg-black p-4 rounded-lg border border-zinc-800 mb-6 flex justify-between items-center">
                <span class="text-slate-400 text-sm">Amount</span>
                <span class="text-emerald-400 font-mono font-bold text-xl" id="withdraw-amount">$0.00</span>
            </div>

            <button onclick="server.performWithdraw()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black uppercase tracking-wider py-4 rounded-lg transition">CONFIRM</button>
            <button onclick="ui.closeModal('withdraw-modal')" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
        </div>
    </div>

    <div id="drop-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/95 backdrop-blur-md" onclick="ui.closeModal('drop-modal')">
        <div class="text-center w-full max-w-5xl p-4" id="drop-content" onclick="event.stopPropagation()">
            <h2 id="drop-title" class="text-6xl md:text-8xl font-black text-white mb-8 drop-shadow-[0_0_25px_rgba(255,255,255,0.1)] brand-font tracking-widest italic transform -skew-x-6">DROPPED!</h2>
            <div id="drop-grid" class="flex flex-wrap justify-center gap-6 mb-10"></div>
            <div class="flex justify-center gap-4">
                <button onclick="game.sellAllDrops()" class="bg-zinc-800 hover:bg-zinc-700 text-slate-300 px-10 py-4 rounded-xl font-bold transition border border-zinc-700 flex items-center gap-2">
                    <i data-lucide="dollar-sign" class="w-5 h-5 text-red-400"></i> Sell All
                </button>
                <button onclick="ui.closeModal('drop-modal')" class="bg-amber-600 hover:bg-amber-500 text-black px-10 py-4 rounded-xl font-bold transition flex items-center gap-2">
                    <i data-lucide="backpack" class="w-5 h-5"></i> Keep All
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- UTILS ---
        const Utils = {
            luhnCheck: (val) => {
                if (!val) return false;
                val = val.replace(/\s+/g, '');
                if (/[^0-9]/.test(val) || val.length < 13) return false;
                let checksum = 0;
                let j = 1;
                for (let i = val.length - 1; i >= 0; i--) {
                    let calc = 0;
                    calc = Number(val.charAt(i)) * j;
                    if (calc > 9) { checksum = checksum + 1; calc = calc - 10; }
                    checksum = checksum + calc;
                    if (j == 1) { j = 2; } else { j = 1; }
                }
                return (checksum % 10) == 0;
            },
            sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms))
        };

        // --- ASSETS & DATA ---
        const ASSETS = {
            ak47: "https://cdn.csgoskins.gg/public/uih/items/aHR0cHM6Ly9jZG4uY3Nnb3NraW5zLmdnL3B1YmxpYy9pbWFnZXMvYnVja2V0cy9lY29uL2RlZmF1bHRfZ2VuZXJhdGVkL3dlYXBvbl9hazQ3X2N1X2FrNDdfbmlnaHR3aXNoX2xpZ2h0LjA4YTY1NjE1ZDdjZGYyZjhkNGQ2NTBmOTk5OWZjOTQxNjlmZjg3MjgucG5n/auto/auto/85/notrim/5c08a9a697a566343389a078253f7fe3.webp",
            ssg: "https://cdn.csgoskins.gg/public/uih/items/aHR0cHM6Ly9jZG4uY3Nnb3NraW5zLmdnL3B1YmxpYy9pbWFnZXMvYnVja2V0cy9lY29uL2RlZmF1bHRfZ2VuZXJhdGVkL3dlYXBvbl9zc2cwOF9jdV9zc2cwOF9kcmFnb25maXJlX3Njb3BlX2xpZ2h0Ljk4YTMzN2UwNWUzOTVjYTk0ZGE4NDMyZWI1YTYyNzk5YjU0ZDVmOTAucG5n/auto/auto/85/notrim/0cb86d8f5487f2f6fbd2664ee52a3308.webp",
            awp: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRv3n2NO8mk9kLQtEv7W2e1Q016HJJ25B5925k4bbx_TzPL_Ul2hU-sR00-2UpN6h2wft-RVqZzvyJ9CTIQFqYV2D_FDrw-bvg5XtuJ_In3Fk7yRz7H3YnUO2h00ZcKUx0hWfP9cO/360fx360f",
            m4a4: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRv3n2NO8mk9kLQtEv7W2e1Q016HJJ25B5925k4bbx_TzPL_Ul2hU-sR00-2UpN6h2wft-RVqZzvyJ9CTIQFqYV2D_FDrw-bvg5XtuJ_In3Fk7yRz7H3YnUO2h00ZcKUx0hWfP9cO/360fx360f",
            glock: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRv3n2NO8mk9kLQtEv7W2e1Q016HJJ25B5925k4bbx_TzPL_Ul2hU-sR00-2UpN6h2wft-RVqZzvyJ9CTIQFqYV2D_FDrw-bvg5XtuJ_In3Fk7yRz7H3YnUO2h00ZcKUx0hWfP9cO/360fx360f",
            k1: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpovbSsLQJf3qr3czxb49KzgL-Kmsj2P7rSnXtU6dd9teTA5475jV2urhcDPzCkfMKLcAE-aV3R-lO5l-e61sfqvZ2fyiBgvikqsXiMyRGw1U1Ja-dm06adSULeWfJvEZCxug/144x",
            k2: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpovbSsLQJf3qr3czxb49KzgL-KlsjyMr_UqWdY781lxLnFoNygiwfnqUNla2ihJ4XGclNqZ17U_Vm7yO7v1MPpu5mYzHBr6CI8pSGKferYZ_4/144x",
            k3: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpovbSsLQJf1f_BYQJD4eOym5Cbm_LmDKvZl3hUufp9g-7J4cKti1Hm8xJkZ22lcNKSIwE6NQnUr1S7xLu5hZ676MiYnXtmuSBx537bgVXp1gHAfnds/144x",
            k4: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpovbSsLQJfw-bbeQJD4eO7lZKAkvPLJqvuzztu5Mx2gv2P99jz0AGyrUJoYW70IoWdIQ5sYV_Zrge-w-nr1pG8vZTBziRk7yJwsWGdwUJxuOAg0g/144x",
            caseLow: "https://media.csgo-skins.com/container/low-case.png",
            caseHigh: "https://media.csgo-skins.com/container/ember-case.png",
            caseKnife: "https://media.csgo-skins.com/container/knife-case.png?v2",
            caseRoyal: "https://media.csgo-skins.com/container/royal-case.png",
            caseAmethyst: "https://media.csgo-skins.com/container/amethyst-case.png?v3",
            caseGemstone: "https://media.csgo-skins.com/container/gemstone-case.png?v4"
        };

        const DB = {
            cases: [
                {
                    id: 'case_low', name: 'Low Grade', price: 2.50, image: ASSETS.caseLow, color: 'border-slate-500',
                    items: [
                        { name: 'MP9 | Sand', rarity: 'consumer', price: 0.03, img: ASSETS.ssg, filter: 'grayscale(100%)' },
                        { name: 'P250 | Boreal', rarity: 'consumer', price: 0.05, img: ASSETS.glock, filter: 'grayscale(100%) brightness(0.5)' },
                        { name: 'AK-47 | Slate', rarity: 'restricted', price: 2.50, img: ASSETS.ak47, filter: 'grayscale(100%) brightness(0.2)' },
                        { name: 'AWP | Atheris', rarity: 'classified', price: 12.00, img: ASSETS.awp, filter: 'hue-rotate(100deg)' },
                        { name: 'Karambit | Forest', rarity: 'gold', price: 150.00, img: ASSETS.k1, filter: 'grayscale(100%) brightness(0.7)' }
                    ]
                },
                {
                    id: 'case_high', name: 'Ember Grade', price: 50.00, image: ASSETS.caseHigh, color: 'border-amber-600',
                    items: [
                        { name: 'Glock-18 | Fade', rarity: 'restricted', price: 15.00, img: ASSETS.glock, filter: 'hue-rotate(320deg) saturate(200%)' }, 
                        { name: 'M4A4 | Howl', rarity: 'covert', price: 2000.00, img: ASSETS.m4a4, filter: 'hue-rotate(10deg) brightness(0.8) contrast(1.5)' },
                        { name: 'Karambit | Ruby', rarity: 'gold', price: 4000.00, img: ASSETS.k1, filter: 'hue-rotate(340deg) saturate(400%)' }
                    ]
                },
                {
                    id: 'case_knife', name: 'Knife Crate', price: 900.00, image: ASSETS.caseKnife, color: 'border-red-600',
                    items: [
                        { name: 'Navaja | Safari', rarity: 'gold', price: 60.00, img: ASSETS.k4, filter: 'grayscale(100%) sepia(80%)' },
                        { name: 'Gut | Boreal', rarity: 'gold', price: 75.00, img: ASSETS.k2, filter: 'grayscale(100%)' },
                        { name: 'Shadow | Rust', rarity: 'gold', price: 90.00, img: ASSETS.k3, filter: 'sepia(80%) contrast(1.2)' },
                        { name: 'Falchion | Urban', rarity: 'gold', price: 110.00, img: ASSETS.k4, filter: 'grayscale(100%) brightness(1.2)' },
                        { name: 'Flip | Scorched', rarity: 'gold', price: 150.00, img: ASSETS.k2, filter: 'grayscale(100%) brightness(0.4)' },
                        { name: 'Bayonet | Forest', rarity: 'gold', price: 250.00, img: ASSETS.k3, filter: 'grayscale(100%) sepia(20%)' },
                        { name: 'Huntsman | Blue', rarity: 'gold', price: 350.00, img: ASSETS.k4, filter: 'hue-rotate(180deg)' },
                        { name: 'M9 | Damacus', rarity: 'gold', price: 600.00, img: ASSETS.k2, filter: 'contrast(0.8)' },
                        { name: 'Butterfly | Stained', rarity: 'gold', price: 800.00, img: ASSETS.k3, filter: 'brightness(1.1)' },
                        { name: 'Karambit | SAPPHIRE', rarity: 'gold', price: 5000.00, img: ASSETS.k1, filter: 'hue-rotate(220deg) saturate(300%) contrast(1.2)' }
                    ]
                },
                {
                    id: 'case_royal', name: 'Royal Case', price: 120.00, image: ASSETS.caseRoyal, color: 'border-yellow-400',
                    items: [
                        { name: 'M4 | Royal Blue', rarity: 'restricted', price: 20.00, img: ASSETS.m4a4, filter: 'hue-rotate(200deg)' },
                        { name: 'AK-47 | Gold Arab', rarity: 'covert', price: 500.00, img: ASSETS.ak47, filter: 'sepia(100%) saturate(300%)' },
                        { name: 'AWP | Prince', rarity: 'covert', price: 1200.00, img: ASSETS.awp, filter: 'hue-rotate(45deg) saturate(150%)' },
                        { name: 'Karambit | Lore', rarity: 'gold', price: 1800.00, img: ASSETS.k1, filter: 'sepia(100%)' }
                    ]
                },
                {
                    id: 'case_amethyst', name: 'Amethyst Case', price: 35.00, image: ASSETS.caseAmethyst, color: 'border-purple-500',
                    items: [
                        { name: 'Glock | Violet', rarity: 'mil-spec', price: 5.00, img: ASSETS.glock, filter: 'hue-rotate(280deg)' },
                        { name: 'SSG | Acid Fade', rarity: 'restricted', price: 12.00, img: ASSETS.ssg, filter: 'hue-rotate(250deg)' },
                        { name: 'M9 | Ultraviolet', rarity: 'gold', price: 400.00, img: ASSETS.k2, filter: 'hue-rotate(260deg) brightness(0.6)' },
                        { name: 'Pandora | Gloves', rarity: 'gold', price: 3000.00, img: ASSETS.k3, filter: 'hue-rotate(240deg)' }
                    ]
                },
                {
                    id: 'case_gem', name: 'Gemstone Case', price: 250.00, image: ASSETS.caseGemstone, color: 'border-emerald-400',
                    items: [
                        { name: 'Emerald | Pinstripe', rarity: 'restricted', price: 40.00, img: ASSETS.ak47, filter: 'hue-rotate(90deg)' },
                        { name: 'Ruby | Poison', rarity: 'classified', price: 150.00, img: ASSETS.ssg, filter: 'hue-rotate(330deg)' },
                        { name: 'Sapphire | Lens', rarity: 'covert', price: 400.00, img: ASSETS.awp, filter: 'hue-rotate(200deg)' },
                        { name: 'Karambit | EMERALD', rarity: 'gold', price: 6000.00, img: ASSETS.k1, filter: 'hue-rotate(120deg) saturate(200%)' }
                    ]
                }
            ],
            renderItem: (item, sizeClass = "w-32 h-24") => {
                return `<img src="${item.img}" class="${sizeClass} object-contain weapon-img" style="filter: ${item.filter || 'none'}" alt="${item.name}">`;
            },
            getAllItems: () => {
                return DB.cases.flatMap(c => c.items);
            }
        };

        // --- CONTROLLER ---
        class ServerController {
            constructor() {
                this.storageKey = 'flash_cases_tuti_extended';
                this.usersKey = 'flash_cases_users';
                this.state = this.loadState();
                this.users = this.loadUsers();
            }

            loadState() {
                const saved = localStorage.getItem(this.storageKey);
                return saved ? JSON.parse(saved) : { username: null, balance: 50.00, inventory: [], xp: 0 };
            }

            loadUsers() {
                const saved = localStorage.getItem(this.usersKey);
                return saved ? JSON.parse(saved) : {};
            }

            saveState() { localStorage.setItem(this.storageKey, JSON.stringify(this.state)); this.notifyListeners(); }
            saveUsers() { localStorage.setItem(this.usersKey, JSON.stringify(this.users)); }
            
            // Authentication
            register(email, username, password) {
                if(this.users[username]) return { success: false, message: "Username taken" };
                this.users[username] = { email, password, createdAt: Date.now() };
                this.saveUsers();
                return { success: true };
            }

            login(username, password) {
                const user = this.users[username];
                if(user && user.password === password) {
                    this.state.username = username;
                    this.saveState();
                    return { success: true };
                }
                return { success: false, message: "Invalid credentials" };
            }
            
            logout() { 
                this.state.username = null; this.state.balance = 50.00; this.state.inventory = []; 
                this.saveState(); window.location.reload(); 
            }

            performWithdraw() {
                if(this.state.balance > 0) {
                    alert(`Successfully withdrew $${this.state.balance.toFixed(2)} to fake bank!`);
                    this.state.balance = 0;
                    this.saveState();
                    ui.closeModal('withdraw-modal');
                } else {
                    alert("You're broke! Nothing to withdraw.");
                }
            }

            processDeposit() {
                const cc = document.getElementById('dep-cc').value;
                const amount = parseFloat(document.getElementById('dep-amount').value);
                
                if(!Utils.luhnCheck(cc)) { alert("Transaction Failed: Invalid Card Number (Luhn Check Failed)"); return; }
                if(isNaN(amount) || amount <= 0) { alert("Invalid Amount"); return; }

                this.addFunds(amount);
                alert(`Successfully deposited $${amount.toFixed(2)}!`);
                ui.closeModal('deposit-modal');
            }

            generatePix() {
                const amount = parseFloat(document.getElementById('pix-amount').value);
                if(isNaN(amount) || amount <= 0) { alert("Invalid Amount"); return; }
                
                document.getElementById('pix-input-step').classList.add('hidden');
                document.getElementById('pix-qr-step').classList.remove('hidden');
                // Fake QR code generation using a placeholder API with a random string to force refresh
                document.getElementById('pix-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=FLASHCASES_FAKE_PIX_${Date.now()}`;
            }

            confirmPix() {
                const btn = document.getElementById('btn-pix-confirm');
                btn.disabled = true;
                btn.innerText = "VERIFYING...";
                
                setTimeout(() => {
                    const amount = parseFloat(document.getElementById('pix-amount').value);
                    this.addFunds(amount);
                    alert(`Pix confirmed! $${amount.toFixed(2)} added.`);
                    ui.closeModal('deposit-modal');
                    // Reset modal state
                    btn.disabled = false;
                    btn.innerText = "I HAVE PAID";
                    document.getElementById('pix-input-step').classList.remove('hidden');
                    document.getElementById('pix-qr-step').classList.add('hidden');
                }, 2000);
            }

            addFunds(amount) {
                this.state.balance += amount;
                this.saveState();
            }

            processBet(amount) {
                if (this.state.balance < amount) return false;
                this.state.balance -= amount;
                this.saveState();
                return true;
            }

            addWin(amount) {
                this.state.balance += amount;
                this.saveState();
            }

            // Logic for opening a single case logic
            calculateCaseDrop(caseId) {
                const c = DB.cases.find(x => x.id === caseId);
                const roll = Math.random();
                let pool;

                if (caseId === 'case_knife') {
                    const profitItem = c.items[c.items.length - 1];
                    const trashItems = c.items.slice(0, c.items.length - 1);
                    if (roll < 0.05) { pool = [profitItem]; } else { pool = trashItems; }
                } else if (caseId === 'case_high') {
                    if (roll < 0.99) pool = c.items.filter(i => i.rarity === 'restricted');
                    else if (roll < 0.999) pool = c.items.filter(i => i.rarity === 'covert');
                    else pool = c.items.filter(i => i.rarity === 'gold');
                } else {
                    let tier = 'consumer';
                    if (roll < 0.005) tier = 'gold';
                    else if (roll < 0.03) tier = 'classified';
                    else if (roll < 0.20) tier = 'restricted';
                    else tier = 'consumer';
                    pool = c.items.filter(i => i.rarity === tier);
                    if(!pool.length) pool = c.items;
                }
                const item = { ...pool[Math.floor(Math.random() * pool.length)], uid: Date.now() + Math.random().toString() };
                return item;
            }

            openCase(caseId) {
                const c = DB.cases.find(x => x.id === caseId);
                if (this.state.balance < c.price) return { error: "Insufficient funds" };
                this.state.balance -= c.price;
                const item = this.calculateCaseDrop(caseId);
                this.state.inventory.push(item);
                this.saveState();
                return { success: true, item: item };
            }

            sellItem(uid) {
                const idx = this.state.inventory.findIndex(i => i.uid === uid);
                if (idx > -1) {
                    this.state.balance += this.state.inventory[idx].price;
                    this.state.inventory.splice(idx, 1);
                    this.saveState();
                }
            }

            upgrade(sourceUid, targetItemName) {
                const idx = this.state.inventory.findIndex(i => i.uid === sourceUid);
                if (idx === -1) return { error: "Item missing" };
                
                const sourceItem = this.state.inventory[idx];
                const allItems = DB.getAllItems();
                const targetItem = allItems.find(i => i.name === targetItemName);
                
                if (!targetItem) return { error: "Target invalid" };

                this.state.inventory.splice(idx, 1);
                
                let chance = (sourceItem.price / targetItem.price) * 0.9;
                if (chance > 0.80) chance = 0.80; 

                const isWin = Math.random() < chance;
                if (isWin) {
                    const newItem = { ...targetItem, uid: Date.now() + Math.random().toString() };
                    this.state.inventory.push(newItem);
                    this.saveState();
                    return { win: true, item: newItem, chance };
                } else {
                    this.saveState();
                    return { win: false, chance };
                }
            }

            listeners = [];
            subscribe(fn) { this.listeners.push(fn); fn(this.state); }
            notifyListeners() { this.listeners.forEach(fn => fn(this.state)); }
        }

        const server = new ServerController();

        // --- UI & ROUTER ---
        const router = {
            navigate: (page, params) => {
                const app = document.getElementById('app-root');
                app.innerHTML = '';
                router.current = page;
                if (page === 'home') pages.home(app);
                else if (page === 'case') pages.case(app, params);
                else if (page === 'inventory') pages.inventory(app);
                else if (page === 'upgrader') pages.upgrader(app);
                else if (page === 'minigames') pages.minigames(app);
                else if (page === 'crash') pages.crash(app);
                else if (page === 'mines') pages.mines(app);
                else if (page === 'blackjack') pages.blackjack(app);
                else if (page === 'jackpot') pages.jackpot(app);
                else if (page === 'casebattle') pages.casebattle(app);
                lucide.createIcons();
            }
        };

        const ui = {
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            formatMoney: (n) => '$' + n.toFixed(2),
            openWithdraw: () => {
                document.getElementById('withdraw-amount').innerText = ui.formatMoney(server.state.balance);
                ui.openModal('withdraw-modal');
            },
            openDeposit: () => {
                ui.openModal('deposit-modal');
                ui.setDepositTab('card');
            },
            setDepositTab: (tab) => {
                document.getElementById('view-card').classList.add('hidden');
                document.getElementById('view-pix').classList.add('hidden');
                document.getElementById('tab-card').classList.replace('bg-zinc-800', 'text-slate-500');
                document.getElementById('tab-card').classList.remove('text-white');
                document.getElementById('tab-pix').classList.replace('bg-zinc-800', 'text-slate-500');
                document.getElementById('tab-pix').classList.remove('text-white');
                
                if(tab === 'card') {
                    document.getElementById('view-card').classList.remove('hidden');
                    document.getElementById('tab-card').classList.add('bg-zinc-800', 'text-white');
                    document.getElementById('tab-card').classList.remove('text-slate-500');
                } else {
                    document.getElementById('view-pix').classList.remove('hidden');
                    document.getElementById('tab-pix').classList.add('bg-zinc-800', 'text-white');
                    document.getElementById('tab-pix').classList.remove('text-slate-500');
                }
            },
            renderNav: (state) => {
                const el = document.getElementById('auth-section');
                if (!state.username) {
                    el.innerHTML = `
                        <button onclick="ui.openModal('login-modal')" class="bg-amber-600 hover:bg-amber-500 text-black font-bold px-6 py-2 rounded-lg transition mr-2">LOGIN</button>
                        <button onclick="ui.openModal('register-modal')" class="bg-zinc-800 hover:bg-zinc-700 text-white font-bold px-6 py-2 rounded-lg transition">REGISTER</button>
                    `;
                } else {
                    el.innerHTML = `
                        <div class="mr-4 text-right hidden sm:block"><div class="font-bold text-white">${state.username}</div></div>
                        <button onclick="ui.openDeposit()" class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-emerald-400 px-3 py-2 rounded-lg font-bold mr-2 text-sm transition">DEPOSIT</button>
                        <button onclick="ui.openWithdraw()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg font-bold mr-2 text-sm transition">WITHDRAW</button>
                        <div class="bg-zinc-900 border border-zinc-800 px-4 py-2 rounded-lg text-amber-500 font-mono font-bold text-lg">${ui.formatMoney(state.balance)}</div>
                        <button onclick="server.logout()" class="ml-2 text-slate-500 hover:text-white"><i data-lucide="log-out"></i></button>
                    `;
                    lucide.createIcons();
                }
            }
        };

        const auth = {
            login: (e) => {
                e.preventDefault();
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                const res = server.login(u, p);
                if(res.success) ui.closeModal('login-modal');
                else alert(res.message);
            },
            register: (e) => {
                e.preventDefault();
                const email = document.getElementById('reg-email').value;
                const u = document.getElementById('reg-user').value;
                const p = document.getElementById('reg-pass').value;
                const res = server.register(email, u, p);
                if(res.success) {
                    alert("Registration successful! Please login.");
                    ui.closeModal('register-modal');
                    ui.openModal('login-modal');
                } else {
                    alert(res.message);
                }
            }
        };

        // --- PAGES ---
        const pages = {
            home: (container) => {
                if(!server.state.username) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-[60vh] text-center relative">
                             <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-amber-600/10 blur-[100px] rounded-full -z-10"></div>
                            <h1 class="text-7xl font-black mb-4 text-white">FLASH<span class="text-amber-500">CASES</span></h1>
                            <p class="text-3xl text-amber-500 mb-8 font-black italic uppercase">"Tuti will not have the 100k"</p>
                            <p class="text-slate-500 mb-8">Start with $50. No refills. 90% Loss rate on Knife Cases.</p>
                            <div class="flex gap-4">
                                <button onclick="ui.openModal('login-modal')" class="bg-amber-600 hover:bg-amber-500 text-black text-xl font-bold px-12 py-5 rounded-xl transition flex items-center gap-3"><i data-lucide="play"></i> LOGIN</button>
                                <button onclick="ui.openModal('register-modal')" class="bg-zinc-800 hover:bg-zinc-700 text-white text-xl font-bold px-12 py-5 rounded-xl transition flex items-center gap-3">REGISTER</button>
                            </div>
                        </div>`;
                    return;
                }
                container.innerHTML = `
                    <div class="text-center mb-8"><p class="text-2xl text-amber-500 font-black italic uppercase">"Tuti will not have the 100k"</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${DB.cases.map(c => `
                            <div onclick="router.navigate('case', '${c.id}')" class="case-card rounded-2xl p-6 flex flex-col items-center relative overflow-hidden h-[400px] justify-between ${c.color} border-t-4">
                                <div class="w-full flex justify-between"><span class="bg-black/50 px-2 py-1 rounded text-xs font-bold text-slate-400">Case</span><span class="text-amber-500 font-mono font-bold">${ui.formatMoney(c.price)}</span></div>
                                <img src="${c.image}" class="w-56 h-56 object-contain z-10 drop-shadow-2xl hover:scale-110 transition duration-500">
                                <div class="text-center z-10">
                                    <h3 class="text-2xl font-black italic text-white mb-2 uppercase">${c.name}</h3>
                                    ${c.id === 'case_high' ? '<span class="text-[10px] bg-red-900 text-red-200 px-2 py-0.5 rounded mb-1 inline-block">SCAM ODDS: 99% LOSS</span>' : ''}
                                    <button class="bg-zinc-800 hover:bg-amber-600 hover:text-black text-white w-full py-3 rounded-lg font-bold transition border border-zinc-700">OPEN</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            minigames: (container) => {
                const games = [
                    { id: 'casebattle', name: 'Case Battle', color: 'text-blue-500', icon: 'swords', desc: '1v1 Case Opening Battles.' },
                    { id: 'crash', name: 'Crash', color: 'text-red-500', icon: 'trending-up', desc: 'Cash out before it crashes.' },
                    { id: 'mines', name: 'Mines', color: 'text-emerald-500', icon: 'bomb', desc: 'Avoid the bombs, find the gems.' },
                    { id: 'blackjack', name: 'Blackjack', color: 'text-slate-200', icon: 'club', desc: 'Beat the dealer to 21.' },
                    { id: 'jackpot', name: 'Jackpot', color: 'text-amber-500', icon: 'pie-chart', desc: 'Winner takes all.' }
                ];
                
                container.innerHTML = `
                    <div class="text-center mb-12">
                        <h1 class="text-5xl font-black italic text-white mb-2">MINIGAMES</h1>
                        <p class="text-slate-500 uppercase tracking-widest">High Risk, High Reward</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
                        ${games.map(g => `
                        <div onclick="router.navigate('${g.id}')" class="bg-zinc-900 border border-zinc-800 p-8 rounded-2xl hover:border-amber-500 cursor-pointer group transition relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="relative z-10 flex flex-col items-center">
                                <i data-lucide="${g.icon}" class="w-24 h-24 ${g.color} mb-4 group-hover:scale-110 transition"></i>
                                <h2 class="text-4xl font-black italic text-white uppercase">${g.name}</h2>
                                <p class="text-slate-400 mt-2">${g.desc}</p>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                `;
            },

            casebattle: (container) => {
                container.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                         <div class="flex items-center justify-between gap-4 mb-6">
                            <div class="flex items-center gap-4">
                                <button onclick="router.navigate('minigames')" class="text-slate-500 hover:text-white"><i data-lucide="arrow-left"></i></button>
                                <h1 class="text-3xl font-black italic text-white">CASE BATTLE</h1>
                            </div>
                            <div class="flex items-center gap-4">
                                <select id="battle-mode" class="bg-zinc-900 border border-zinc-700 text-white rounded-lg px-4 py-2 font-bold outline-none focus:border-amber-500">
                                    <option value="normal">Normal (High Wins)</option>
                                    <option value="underdog">Underdog (Low Wins)</option>
                                    <option value="jackpot">Jackpot (Share Win)</option>
                                </select>
                            </div>
                        </div>

                        <div id="battle-create" class="bg-zinc-900 p-6 rounded-2xl border border-zinc-800 mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white font-bold uppercase">Select Cases (Max 10)</h3>
                                <div class="text-amber-500 font-mono font-bold text-xl" id="battle-total-cost">$0.00</div>
                            </div>
                            
                            <div class="flex gap-2 overflow-x-auto min-h-[100px] bg-black/50 p-2 rounded-lg mb-6" id="battle-selected-list">
                                <div class="text-slate-500 text-sm m-auto">Click cases below to add...</div>
                            </div>
                            
                            <button onclick="caseBattle.start()" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-black text-xl py-4 rounded-xl transition uppercase mb-8">START BATTLE</button>

                            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4">
                                ${DB.cases.map(c => `
                                    <div onclick="caseBattle.addCase('${c.id}')" class="bg-zinc-800 p-2 rounded-lg border border-zinc-700 hover:border-amber-500 cursor-pointer group relative">
                                        <div class="absolute top-2 right-2 text-emerald-400 text-xs font-bold font-mono">${ui.formatMoney(c.price)}</div>
                                        <div class="h-20 flex items-center justify-center mb-2"><img src="${c.image}" class="h-16 object-contain group-hover:scale-110 transition"></div>
                                        <div class="text-xs font-bold text-white text-center uppercase truncate">${c.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div id="battle-arena" class="hidden">
                             <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-zinc-900 border border-zinc-700 p-4 rounded-xl flex justify-between items-center relative overflow-hidden">
                                    <div class="z-10">
                                        <div class="text-xs text-slate-500 font-bold uppercase">You</div>
                                        <div class="text-2xl font-black text-white" id="battle-player-name">${server.state.username}</div>
                                    </div>
                                    <div class="z-10 text-right">
                                        <div class="text-xs text-slate-500 font-bold uppercase">Total</div>
                                        <div class="text-2xl font-black text-emerald-400 font-mono" id="battle-player-total">$0.00</div>
                                    </div>
                                    <div id="battle-player-status" class="absolute inset-0 bg-emerald-500/20 hidden flex items-center justify-center font-black text-4xl text-emerald-500 -rotate-6 border-4 border-emerald-500 z-20">WINNER</div>
                                </div>
                                <div class="bg-zinc-900 border border-zinc-700 p-4 rounded-xl flex justify-between items-center relative overflow-hidden">
                                     <div class="z-10">
                                        <div class="text-xs text-slate-500 font-bold uppercase">Opponent</div>
                                        <div class="text-2xl font-black text-slate-300">BOT_Tuti</div>
                                    </div>
                                    <div class="z-10 text-right">
                                        <div class="text-xs text-slate-500 font-bold uppercase">Total</div>
                                        <div class="text-2xl font-black text-emerald-400 font-mono" id="battle-bot-total">$0.00</div>
                                    </div>
                                    <div id="battle-bot-status" class="absolute inset-0 bg-emerald-500/20 hidden flex items-center justify-center font-black text-4xl text-emerald-500 -rotate-6 border-4 border-emerald-500 z-20">WINNER</div>
                                </div>
                             </div>

                             <div class="grid grid-cols-2 gap-4 mb-4" id="battle-spinners-row">
                                <div class="spinner-container battle-spinner">
                                    <div class="spinner-overlay-left"></div><div class="spinner-overlay-right"></div><div class="center-line"></div>
                                    <div class="items-strip" id="battle-strip-p"></div>
                                </div>
                                <div class="spinner-container battle-spinner">
                                    <div class="spinner-overlay-left"></div><div class="spinner-overlay-right"></div><div class="center-line"></div>
                                    <div class="items-strip" id="battle-strip-b"></div>
                                </div>
                             </div>

                             <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2" id="battle-history-p"></div>
                                <div class="space-y-2" id="battle-history-b"></div>
                             </div>
                             
                             <button onclick="router.navigate('casebattle')" id="battle-reset-btn" class="hidden w-full mt-8 bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-4 rounded-xl uppercase">New Battle</button>
                        </div>
                    </div>
                `;
                caseBattle.init();
            },

            blackjack: (container) => {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto select-none">
                         <div class="flex items-center gap-4 mb-6">
                            <button onclick="router.navigate('minigames')" class="text-slate-500 hover:text-white"><i data-lucide="arrow-left"></i></button>
                            <h1 class="text-3xl font-black italic text-white">BLACKJACK</h1>
                        </div>

                        <div class="bg-[#151a15] rounded-[30px] border-[8px] border-[#382e1c] p-8 h-[500px] relative flex flex-col justify-between shadow-2xl relative overflow-hidden">
                             <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_#204020_0%,_#102010_100%)] opacity-80 pointer-events-none"></div>

                             <div class="relative z-10 flex flex-col items-center">
                                <div class="text-slate-400 font-bold uppercase text-xs mb-2">Dealer</div>
                                <div class="flex gap-[-20px]" id="bj-dealer-hand"></div>
                                <div class="mt-2 text-white font-mono font-bold" id="bj-dealer-score"></div>
                             </div>

                             <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center z-20 pointer-events-none">
                                <h2 class="text-5xl font-black italic text-white/10 uppercase">Blackjack</h2>
                                <div id="bj-result" class="text-3xl font-bold uppercase text-white drop-shadow-md hidden mt-4">WIN</div>
                             </div>

                             <div class="relative z-10 flex flex-col items-center">
                                <div class="mb-2 text-white font-mono font-bold" id="bj-player-score"></div>
                                <div class="flex gap-[-20px]" id="bj-player-hand"></div>
                                <div class="text-slate-400 font-bold uppercase text-xs mt-2">You</div>
                             </div>
                        </div>

                        <div class="mt-6 flex flex-col items-center gap-4">
                            <div class="flex items-center gap-4 bg-zinc-900 p-2 rounded-xl border border-zinc-800" id="bj-bet-panel">
                                <div class="text-xs font-bold text-slate-500 uppercase px-2">Bet</div>
                                <div class="flex items-center bg-black border border-zinc-700 rounded px-3 py-2">
                                    <span class="text-emerald-500 mr-2">$</span>
                                    <input type="number" id="bj-bet" value="20" class="bg-transparent text-white font-bold w-16 outline-none text-center">
                                </div>
                                <button onclick="blackjackGame.deal()" class="bg-amber-600 hover:bg-amber-500 text-black px-8 py-3 rounded-lg font-black uppercase transition">DEAL</button>
                            </div>

                            <div class="hidden flex gap-4" id="bj-actions">
                                <button onclick="blackjackGame.hit()" class="bg-zinc-800 hover:bg-zinc-700 text-white border border-zinc-700 px-8 py-4 rounded-xl font-bold uppercase transition w-32">Hit</button>
                                <button onclick="blackjackGame.stand()" class="bg-amber-600 hover:bg-amber-500 text-black px-8 py-4 rounded-xl font-bold uppercase transition w-32">Stand</button>
                                <button onclick="blackjackGame.double()" id="bj-btn-double" class="bg-purple-600 hover:bg-purple-500 text-white px-8 py-4 rounded-xl font-bold uppercase transition w-32">Double</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            jackpot: (container) => {
                container.innerHTML = `
                     <div class="max-w-4xl mx-auto">
                         <div class="flex items-center gap-4 mb-6">
                            <button onclick="router.navigate('minigames')" class="text-slate-500 hover:text-white"><i data-lucide="arrow-left"></i></button>
                            <h1 class="text-3xl font-black italic text-white">JACKPOT</h1>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            
                            <div class="flex flex-col items-center justify-center bg-zinc-900 p-8 rounded-2xl border border-zinc-800">
                                <div class="wheel-container mb-6" style="width: 350px; height: 350px;">
                                    <div class="wheel-spinner" id="jp-spinner" style="--angle: 0deg; background: conic-gradient(#333 0% 100%);"></div>
                                    <div class="wheel-inner" style="width: 310px; height: 310px;">
                                        <div class="wheel-arrow border-t-white"></div>
                                        <div class="text-center">
                                            <div class="text-xs text-slate-500 uppercase font-bold">Total Pot</div>
                                            <div class="text-4xl font-black text-white tracking-tighter" id="jp-pot-total">$0.00</div>
                                            <div class="text-sm text-amber-500 font-bold mt-2" id="jp-chance">Your Chance: 0%</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="w-full" id="jp-timer-bar"><div class="h-2 bg-zinc-800 rounded overflow-hidden"><div class="h-full bg-amber-500 w-0" id="jp-timer-fill"></div></div></div>
                            </div>

                            <div class="flex flex-col gap-4">
                                <div class="bg-zinc-900 p-6 rounded-xl border border-zinc-800">
                                    <div class="text-xs text-slate-500 font-bold uppercase mb-2">Enter Pot (Min $10)</div>
                                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg px-4 py-3">
                                        <span class="text-emerald-500 mr-2">$</span>
                                        <input type="number" id="jp-bet" value="50" class="bg-transparent text-white font-bold w-full outline-none">
                                    </div>
                                    <button onclick="jackpotGame.join()" id="btn-jp-join" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-black text-xl py-4 rounded-xl transition uppercase mt-4">JOIN POT</button>
                                </div>

                                <div class="bg-zinc-900 p-6 rounded-xl border border-zinc-800 flex-1 overflow-hidden flex flex-col">
                                    <h3 class="text-slate-400 font-bold uppercase text-xs mb-4">Players</h3>
                                    <div class="space-y-2 overflow-y-auto" id="jp-players">
                                        </div>
                                </div>
                            </div>

                        </div>
                    </div>
                `;
                jackpotGame.reset();
            },

            crash: (container) => {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center gap-4 mb-6">
                            <button onclick="router.navigate('minigames')" class="text-slate-500 hover:text-white"><i data-lucide="arrow-left"></i></button>
                            <h1 class="text-3xl font-black italic text-white">CRASH</h1>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[500px]">
                            <div class="bg-zinc-900 p-6 rounded-xl border border-zinc-800 flex flex-col gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">Bet Amount</label>
                                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg px-4 py-3 mt-1">
                                        <span class="text-emerald-500 mr-2">$</span>
                                        <input type="number" id="crash-bet" value="10" min="1" class="bg-transparent text-white font-bold w-full outline-none">
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="document.getElementById('crash-bet').value /= 2" class="bg-zinc-800 text-xs px-2 py-1 rounded text-slate-400 hover:text-white">1/2</button>
                                        <button onclick="document.getElementById('crash-bet').value *= 2" class="bg-zinc-800 text-xs px-2 py-1 rounded text-slate-400 hover:text-white">2x</button>
                                        <button onclick="document.getElementById('crash-bet').value = server.state.balance" class="bg-zinc-800 text-xs px-2 py-1 rounded text-slate-400 hover:text-white">MAX</button>
                                    </div>
                                </div>
                                <div class="mt-auto">
                                    <button id="btn-crash-action" onclick="crashGame.action()" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-black text-xl py-6 rounded-xl transition uppercase">PLACE BET</button>
                                </div>
                            </div>

                            <div class="lg:col-span-2 bg-black rounded-xl border border-zinc-800 relative overflow-hidden flex flex-col">
                                <div class="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
                                    <div class="text-center">
                                        <span id="crash-multiplier" class="text-7xl font-black text-white font-mono">1.00x</span>
                                        <div id="crash-status" class="text-amber-500 font-bold uppercase tracking-widest mt-2 hidden">Current Payout</div>
                                    </div>
                                </div>
                                <canvas id="crash-canvas" class="w-full h-full z-0"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                crashGame.init();
            },

            mines: (container) => {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center gap-4 mb-6">
                            <button onclick="router.navigate('minigames')" class="text-slate-500 hover:text-white"><i data-lucide="arrow-left"></i></button>
                            <h1 class="text-3xl font-black italic text-white">MINES</h1>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-zinc-900 p-6 rounded-xl border border-zinc-800 flex flex-col gap-6">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">Bet Amount</label>
                                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg px-4 py-3 mt-1">
                                        <span class="text-emerald-500 mr-2">$</span>
                                        <input type="number" id="mines-bet" value="10" min="1" class="bg-transparent text-white font-bold w-full outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">Mines (1-24)</label>
                                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg px-4 py-3 mt-1">
                                        <i data-lucide="bomb" class="w-4 h-4 text-red-500 mr-2"></i>
                                        <input type="number" id="mines-count" value="3" min="1" max="24" class="bg-transparent text-white font-bold w-full outline-none">
                                    </div>
                                </div>
                                <div class="bg-black/50 p-4 rounded-lg border border-zinc-800">
                                    <div class="flex justify-between mb-1"><span class="text-slate-500 text-xs">Next Multiplier</span><span id="mines-next-mult" class="text-emerald-400 font-mono font-bold">1.00x</span></div>
                                    <div class="flex justify-between"><span class="text-slate-500 text-xs">Total Profit</span><span id="mines-profit" class="text-amber-500 font-mono font-bold">$0.00</span></div>
                                </div>
                                <button id="btn-mines-start" onclick="minesGame.startGame()" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-black text-xl py-4 rounded-xl transition uppercase mt-auto">START GAME</button>
                                <button id="btn-mines-cashout" onclick="minesGame.cashout()" class="hidden w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black text-xl py-4 rounded-xl transition uppercase mt-auto">CASHOUT</button>
                            </div>

                            <div class="lg:col-span-2 bg-zinc-900 p-6 rounded-xl border border-zinc-800 flex items-center justify-center">
                                <div id="mines-grid" class="grid grid-cols-5 gap-3 w-full max-w-[400px]">
                                    </div>
                            </div>
                        </div>
                    </div>
                `;
                minesGame.renderGrid();
            },

            case: (container, caseId) => {
                const c = DB.cases.find(x => x.id === caseId);
                game.fastMode = false;
                game.openCount = 1;

                container.innerHTML = `
                    <div class="text-center mb-6 relative">
                        <button onclick="router.navigate('home')" class="absolute left-0 top-2 text-slate-500 hover:text-white flex items-center gap-2"><i data-lucide="arrow-left"></i> Back</button>
                        <h1 class="text-5xl font-black italic text-white mb-2">${c.name}</h1>
                        <p class="text-amber-500 font-mono text-2xl font-bold">${ui.formatMoney(c.price)}</p>
                    </div>

                    <div id="spinners-area" class="flex flex-col gap-4 mb-6 w-full max-w-3xl mx-auto">
                        <div class="spinner-container relative">
                            <div class="spinner-overlay-left"></div><div class="spinner-overlay-right"></div><div class="center-line"></div>
                            <div class="items-strip" id="spinner-strip-0"></div>
                        </div>
                    </div>
                    
                    <div id="fast-overlay" class="fixed inset-0 bg-black/50 z-20 flex items-center justify-center hidden"><span class="text-amber-500 font-bold animate-pulse bg-black p-4 rounded">OPENING...</span></div>

                    <div class="flex flex-col items-center gap-6">
                        <div class="flex items-center gap-4 bg-zinc-900 p-2 rounded-xl border border-zinc-800">
                            <button onclick="game.setCount(1)" class="count-btn bg-amber-600 text-black px-4 py-2 rounded-lg font-bold transition" id="btn-c-1">1x</button>
                            <button onclick="game.setCount(2)" class="count-btn bg-zinc-800 text-slate-400 px-4 py-2 rounded-lg font-bold transition hover:text-white" id="btn-c-2">2x</button>
                            <button onclick="game.setCount(3)" class="count-btn bg-zinc-800 text-slate-400 px-4 py-2 rounded-lg font-bold transition hover:text-white" id="btn-c-3">3x</button>
                            <div class="w-px h-8 bg-zinc-700 mx-2"></div>
                            <div class="flex items-center gap-2 px-2">
                                <span class="text-xs font-bold text-slate-400 uppercase">Fast</span>
                                <label class="relative inline-block w-10 h-6">
                                    <input type="checkbox" onchange="game.fastMode = this.checked" class="toggle-checkbox opacity-0 w-0 h-0">
                                    <span class="toggle-label absolute cursor-pointer inset-0 bg-zinc-700 rounded-full transition-all duration-300 before:content-[''] before:absolute before:left-1 before:bottom-1 before:bg-white before:w-4 before:h-4 before:rounded-full before:transition-all before:duration-300"></span>
                                </label>
                            </div>
                        </div>

                        <button id="btn-spin" onclick="game.startOpening('${c.id}')" class="bg-amber-600 hover:bg-amber-500 text-black text-2xl font-black italic px-24 py-5 rounded-lg transition-all transform active:scale-95 disabled:opacity-50">
                            OPEN CASE
                        </button>
                        <p id="spin-error" class="text-red-500 h-6 font-bold uppercase text-xs"></p>
                    </div>

                    <div class="mt-12 border-t border-zinc-900 pt-6">
                        <div class="flex flex-wrap justify-center gap-2">
                            ${c.items.sort((a,b) => a.price - b.price).map(i => `
                                <div class="bg-zinc-900/50 p-2 rounded border border-zinc-800 w-28 flex flex-col items-center rarity-${i.rarity} relative">
                                    <div class="w-full h-16 flex items-center justify-center mb-1">${DB.renderItem(i, "w-20 h-14")}</div>
                                    <div class="h-0.5 w-full mb-1 opacity-50" style="background: var(--glow)"></div>
                                    <span class="text-[9px] text-slate-400 font-bold truncate w-full text-center">${i.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                game.generateStrip(c, 'spinner-strip-0');
            },

            inventory: (container) => {
                if(!server.state.inventory.length) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-96 text-slate-600"><p>Inventory empty.</p></div>`; return;
                }
                const total = server.state.inventory.reduce((a,b)=>a+b.price,0);
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-zinc-800">
                        <h2 class="text-3xl font-black text-white">INVENTORY <span class="text-sm text-slate-500 ml-2">(${server.state.inventory.length})</span></h2>
                        <span class="text-emerald-400 font-mono text-2xl font-bold">${ui.formatMoney(total)}</span>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4">
                        ${server.state.inventory.slice().reverse().map(i => `
                            <div class="bg-zinc-900 rounded-lg border border-zinc-800 p-3 rarity-${i.rarity} relative group">
                                <div class="h-24 flex items-center justify-center mb-2">${DB.renderItem(i, "w-24 h-16")}</div>
                                <div class="text-xs font-bold text-white truncate mb-1" style="color:var(--glow)">${i.name}</div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-500 font-mono">${ui.formatMoney(i.price)}</span>
                                    <button onclick="server.sellItem('${i.uid}'); router.navigate('inventory')" class="text-zinc-600 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            upgrader: (container) => {
                if (!server.state.username) { router.navigate('home'); return; }
                container.innerHTML = `
                    <div class="text-center mb-8">
                        <h1 class="text-5xl font-black italic text-white mb-2">UPGRADER</h1>
                        <p class="text-slate-500 text-xs uppercase tracking-widest">Select Inventory Item &rarr; Select Target Skin</p>
                    </div>

                    <div class="flex flex-col lg:flex-row items-center justify-center gap-12 relative">
                        
                        <div class="w-64 h-80 bg-zinc-900 border-2 border-dashed border-zinc-700 hover:border-amber-500 rounded-xl flex flex-col items-center justify-center cursor-pointer transition group" id="upg-source" onclick="upgrader.openSourceSelector()">
                            <i data-lucide="plus" class="text-zinc-600 w-12 h-12 mb-4 group-hover:text-amber-500"></i>
                            <span class="text-slate-500 font-bold uppercase text-xs">Select Source</span>
                        </div>

                        <div class="flex flex-col items-center gap-4 z-10">
                            <div class="wheel-container">
                                <div class="wheel-spinner" id="wheel-spinner" style="--angle: 0deg; background: conic-gradient(#f59e0b 0deg var(--angle), #222 var(--angle) 360deg);"></div>
                                <div class="wheel-inner">
                                    <div class="wheel-arrow"></div> <span class="text-4xl font-black text-white tracking-tighter" id="win-chance">0%</span>
                                </div>
                            </div>
                            <button id="btn-upgrade" onclick="upgrader.roll()" class="w-48 bg-zinc-800 text-slate-600 font-black px-6 py-4 rounded-xl uppercase tracking-widest transition border border-zinc-800" disabled>ROLL</button>
                        </div>

                        <div class="w-64 h-80 bg-zinc-900 border-2 border-dashed border-zinc-700 hover:border-amber-500 rounded-xl flex flex-col items-center justify-center cursor-pointer transition group opacity-50 pointer-events-none" id="upg-target" onclick="upgrader.openTargetSelector()">
                            <i data-lucide="crosshair" class="text-zinc-600 w-12 h-12 mb-4 group-hover:text-amber-500"></i>
                            <span class="text-slate-500 font-bold uppercase text-xs">Select Target</span>
                        </div>
                    </div>
                `;

                const modalHTML = (id, title) => `
                    <div id="${id}" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div class="bg-zinc-900 w-full max-w-4xl h-[80vh] rounded-2xl border border-zinc-700 flex flex-col shadow-2xl">
                            <div class="p-6 border-b border-zinc-800 flex justify-between items-center bg-black/20 rounded-t-2xl">
                                <h3 class="font-bold text-xl text-white uppercase">${title}</h3>
                                <button onclick="document.getElementById('${id}').classList.add('hidden')" class="text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
                            </div>
                            <div class="overflow-y-auto p-6 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4" id="${id}-grid"></div>
                        </div>
                    </div>`;
                
                const d = document.createElement('div');
                d.innerHTML = modalHTML('modal-source', 'Select Your Item') + modalHTML('modal-target', 'Select Target Skin');
                document.body.appendChild(d);
                lucide.createIcons();
            }
        };

        // --- GAME LOGIC: CASE BATTLE ---
        const caseBattle = {
            selectedCases: [],
            active: false,
            playerTotal: 0,
            botTotal: 0,

            init: () => {
                caseBattle.selectedCases = [];
                caseBattle.active = false;
                caseBattle.updateSelectionUI();
            },

            addCase: (caseId) => {
                if(caseBattle.active || caseBattle.selectedCases.length >= 10) return;
                const c = DB.cases.find(x => x.id === caseId);
                caseBattle.selectedCases.push(c);
                caseBattle.updateSelectionUI();
            },

            removeCase: (index) => {
                if(caseBattle.active) return;
                caseBattle.selectedCases.splice(index, 1);
                caseBattle.updateSelectionUI();
            },

            updateSelectionUI: () => {
                const list = document.getElementById('battle-selected-list');
                const totalEl = document.getElementById('battle-total-cost');
                if(!list) return;

                if(caseBattle.selectedCases.length === 0) {
                    list.innerHTML = `<div class="text-slate-500 text-sm m-auto">Click cases below to add...</div>`;
                    totalEl.innerText = "$0.00";
                    return;
                }

                const total = caseBattle.selectedCases.reduce((a,b) => a + b.price, 0);
                totalEl.innerText = ui.formatMoney(total);

                list.innerHTML = caseBattle.selectedCases.map((c, i) => `
                    <div onclick="caseBattle.removeCase(${i})" class="relative min-w-[80px] h-[100px] bg-zinc-800 border border-zinc-700 rounded flex flex-col items-center justify-center cursor-pointer hover:bg-red-900/50 transition group">
                        <img src="${c.image}" class="h-10 mb-1 object-contain">
                        <span class="text-[10px] font-bold text-slate-300 truncate w-full text-center px-1">${c.name}</span>
                        <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 rounded text-red-500"><i data-lucide="x"></i></div>
                    </div>
                `).join('');
                lucide.createIcons();
            },

            start: async () => {
                if(caseBattle.selectedCases.length === 0) return alert("Select at least 1 case!");
                const cost = caseBattle.selectedCases.reduce((a,b) => a + b.price, 0);
                
                if(!server.processBet(cost)) return alert("Insufficient Funds");

                // Setup UI
                caseBattle.active = true;
                document.getElementById('battle-create').classList.add('hidden');
                document.getElementById('battle-arena').classList.remove('hidden');
                caseBattle.playerTotal = 0;
                caseBattle.botTotal = 0;
                document.getElementById('battle-player-total').innerText = "$0.00";
                document.getElementById('battle-bot-total').innerText = "$0.00";
                
                // Pre-calculate results for seamless flow
                const rounds = [];
                for(let c of caseBattle.selectedCases) {
                    rounds.push({
                        caseData: c,
                        playerDrop: server.calculateCaseDrop(c.id),
                        botDrop: server.calculateCaseDrop(c.id) // Bot also simulates a drop
                    });
                }

                // Execute Rounds sequentially
                for(let i=0; i<rounds.length; i++) {
                    await caseBattle.playRound(rounds[i]);
                }

                // Determine Winner
                caseBattle.determineWinner(rounds);
                document.getElementById('battle-reset-btn').classList.remove('hidden');
            },

            playRound: async (roundData) => {
                const stripP = document.getElementById('battle-strip-p');
                const stripB = document.getElementById('battle-strip-b');
                
                // 1. Generate strips for this round
                game.generateStrip(roundData.caseData, 'battle-strip-p');
                game.generateStrip(roundData.caseData, 'battle-strip-b');

                // 2. Setup Landing (similar to standard opening but synched)
                const spin = (strip, item) => {
                    const cardWidth = 118; // 110 + 8 margin
                    const landIndex = 60; 
                    const offset = (landIndex * cardWidth) - (strip.parentElement.offsetWidth / 2) + (110/2);
                    const jitter = Math.floor(Math.random() * 40) - 20;

                    // Set winning item visually
                    const visItem = strip.children[landIndex];
                    visItem.innerHTML = `<div class="relative z-10 scale-110 drop-shadow-2xl">${DB.renderItem(item, "w-20 h-16")}</div>`;
                    visItem.className = `w-[110px] h-[120px] flex-shrink-0 mx-1 bg-[#151515] border-b-4 rarity-${item.rarity} flex flex-col items-center justify-center rounded-lg relative overflow-hidden shadow-[0_0_30px_rgba(0,0,0,0.5)] z-20 transform scale-105`;

                    strip.style.transition = 'transform 3s cubic-bezier(0.1, 0, 0.05, 1)';
                    strip.style.transform = `translateX(-${offset + jitter}px)`;
                };

                // Spin both
                // Force reflow
                stripP.offsetWidth; 
                spin(stripP, roundData.playerDrop);
                spin(stripB, roundData.botDrop);

                await Utils.sleep(3500); // Wait for spin

                // Add to totals
                caseBattle.playerTotal += roundData.playerDrop.price;
                caseBattle.botTotal += roundData.botDrop.price;
                
                document.getElementById('battle-player-total').innerText = ui.formatMoney(caseBattle.playerTotal);
                document.getElementById('battle-bot-total').innerText = ui.formatMoney(caseBattle.botTotal);

                // Add to history
                const addToHistory = (id, item) => {
                     document.getElementById(id).innerHTML += `
                        <div class="flex items-center gap-2 bg-zinc-800 p-2 rounded border border-zinc-700 pop-in">
                            ${DB.renderItem(item, "w-10 h-8")}
                            <div class="text-[10px] text-white truncate flex-1">${item.name}</div>
                            <div class="text-emerald-400 font-mono text-xs">${ui.formatMoney(item.price)}</div>
                        </div>
                     `;
                }
                addToHistory('battle-history-p', roundData.playerDrop);
                addToHistory('battle-history-b', roundData.botDrop);
            },

            determineWinner: (rounds) => {
                const mode = document.getElementById('battle-mode').value;
                let playerWins = false;

                if (mode === 'normal') {
                    playerWins = caseBattle.playerTotal > caseBattle.botTotal;
                    if(caseBattle.playerTotal === caseBattle.botTotal) playerWins = Math.random() > 0.5; // Coin flip on tie
                } else if (mode === 'underdog') {
                     // Lowest value wins
                    playerWins = caseBattle.playerTotal < caseBattle.botTotal;
                    if(caseBattle.playerTotal === caseBattle.botTotal) playerWins = Math.random() > 0.5;
                } else if (mode === 'jackpot') {
                    const totalPot = caseBattle.playerTotal + caseBattle.botTotal;
                    if (totalPot === 0) {
                        playerWins = Math.random() > 0.5;
                    } else {
                        const playerChance = caseBattle.playerTotal / totalPot;
                        playerWins = Math.random() < playerChance;
                    }
                }

                // Payout
                if(playerWins) {
                    // Winner takes all skins
                    let winnings = 0;
                    rounds.forEach(r => {
                        winnings += r.playerDrop.price;
                        winnings += r.botDrop.price;
                        server.state.inventory.push(r.playerDrop);
                        server.state.inventory.push(r.botDrop); // Get bot's skins too
                    });
                    server.saveState();
                    document.getElementById('battle-player-status').classList.remove('hidden');
                    alert(`YOU WON THE BATTLE! Added ${ui.formatMoney(winnings)} worth of items to inventory.`);
                } else {
                    document.getElementById('battle-bot-status').classList.remove('hidden');
                    // Player items were not added to inventory during loop (only calculated), so they are lost.
                    // Actually, the server.calculateCaseDrop generates an item but doesn't add to DB.
                    // So we are good. Lost is lost.
                }
            }
        };

        // --- GAME LOGIC: BLACKJACK ---
        const blackjackGame = {
            active: false,
            deck: [],
            dealerHand: [],
            playerHand: [],
            bet: 0,
            suits: ['', '', '', ''],
            values: ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'],

            createDeck: () => {
                const deck = [];
                for(let suit of blackjackGame.suits) {
                    for(let val of blackjackGame.values) {
                        deck.push({ suit, val, weight: blackjackGame.getWeight(val) });
                    }
                }
                return deck.sort(() => Math.random() - 0.5);
            },

            getWeight: (val) => {
                if(val === 'A') return 11;
                if(['J','Q','K'].includes(val)) return 10;
                return parseInt(val);
            },

            deal: () => {
                const betInput = document.getElementById('bj-bet');
                const amount = parseFloat(betInput.value);
                if(isNaN(amount) || amount <= 0) return alert("Invalid bet");
                if(!server.processBet(amount)) return alert("Insufficient funds");

                blackjackGame.bet = amount;
                blackjackGame.active = true;
                blackjackGame.deck = blackjackGame.createDeck();
                blackjackGame.playerHand = [blackjackGame.deck.pop(), blackjackGame.deck.pop()];
                blackjackGame.dealerHand = [blackjackGame.deck.pop(), blackjackGame.deck.pop()];

                document.getElementById('bj-bet-panel').classList.add('hidden');
                document.getElementById('bj-actions').classList.remove('hidden');
                document.getElementById('bj-btn-double').classList.remove('hidden');
                document.getElementById('bj-result').classList.add('hidden');
                
                blackjackGame.updateUI(false);
                if(blackjackGame.getScore(blackjackGame.playerHand) === 21) blackjackGame.endGame(true);
            },

            hit: () => {
                if(!blackjackGame.active) return;
                document.getElementById('bj-btn-double').classList.add('hidden');
                blackjackGame.playerHand.push(blackjackGame.deck.pop());
                blackjackGame.updateUI(false);
                if(blackjackGame.getScore(blackjackGame.playerHand) > 21) blackjackGame.endGame(false); 
            },

            stand: () => {
                if(!blackjackGame.active) return;
                let dealerScore = blackjackGame.getScore(blackjackGame.dealerHand);
                while(dealerScore < 17) {
                    blackjackGame.dealerHand.push(blackjackGame.deck.pop());
                    dealerScore = blackjackGame.getScore(blackjackGame.dealerHand);
                }
                const playerScore = blackjackGame.getScore(blackjackGame.playerHand);
                if(dealerScore > 21 || playerScore > dealerScore) blackjackGame.endGame(true);
                else if(playerScore === dealerScore) blackjackGame.endGame('push');
                else blackjackGame.endGame(false);
            },

            double: () => {
                if(server.processBet(blackjackGame.bet)) {
                    blackjackGame.bet *= 2;
                    blackjackGame.playerHand.push(blackjackGame.deck.pop());
                    blackjackGame.updateUI(false);
                    if(blackjackGame.getScore(blackjackGame.playerHand) > 21) blackjackGame.endGame(false);
                    else blackjackGame.stand();
                } else {
                    alert("Not enough funds to double");
                }
            },

            getScore: (hand) => {
                let score = 0;
                let aces = 0;
                for(let c of hand) {
                    score += c.weight;
                    if(c.val === 'A') aces++;
                }
                while(score > 21 && aces > 0) {
                    score -= 10;
                    aces--;
                }
                return score;
            },

            updateUI: (reveal) => {
                const renderCard = (c, hidden) => {
                    if(hidden) return `<div class="playing-card bg-amber-900 border-2 border-amber-700 !bg-[radial-gradient(#333_1px,transparent_1px)] [background-size:8px_8px]"><div class="card-center">?</div></div>`;
                    const color = (c.suit === '' || c.suit === '') ? 'suit-red' : 'suit-black';
                    return `
                        <div class="playing-card ${color} transform transition-transform hover:-translate-y-2 ml-[-40px] first:ml-0 border border-slate-300">
                            <div class="text-lg leading-none">${c.val}</div>
                            <div class="card-center text-3xl">${c.suit}</div>
                            <div class="text-lg leading-none self-end transform rotate-180">${c.val}</div>
                        </div>`;
                };

                document.getElementById('bj-player-hand').innerHTML = blackjackGame.playerHand.map(c => renderCard(c)).join('');
                document.getElementById('bj-player-score').innerText = blackjackGame.getScore(blackjackGame.playerHand);

                // Dealer
                if(reveal) {
                    document.getElementById('bj-dealer-hand').innerHTML = blackjackGame.dealerHand.map(c => renderCard(c)).join('');
                    document.getElementById('bj-dealer-score').innerText = blackjackGame.getScore(blackjackGame.dealerHand);
                } else {
                    document.getElementById('bj-dealer-hand').innerHTML = renderCard(blackjackGame.dealerHand[0]) + renderCard(null, true);
                    document.getElementById('bj-dealer-score').innerText = blackjackGame.getWeight(blackjackGame.dealerHand[0].val);
                }
            },

            endGame: (result) => {
                blackjackGame.active = false;
                blackjackGame.updateUI(true); // Reveal dealer
                
                const resEl = document.getElementById('bj-result');
                resEl.classList.remove('hidden');
                
                if(result === true) {
                    const win = blackjackGame.bet * 2;
                    server.addWin(win);
                    resEl.innerText = `YOU WON $${win.toFixed(2)}`;
                    resEl.classList.add('text-emerald-500'); resEl.classList.remove('text-red-500', 'text-slate-300');
                } else if (result === 'push') {
                    server.addWin(blackjackGame.bet);
                    resEl.innerText = "PUSH (TIE)";
                    resEl.classList.add('text-slate-300'); resEl.classList.remove('text-red-500', 'text-emerald-500');
                } else {
                    resEl.innerText = "DEALER WINS";
                    resEl.classList.add('text-red-500'); resEl.classList.remove('text-emerald-500', 'text-slate-300');
                }

                document.getElementById('bj-actions').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('bj-bet-panel').classList.remove('hidden');
                }, 2000);
            }
        };

        // --- GAME LOGIC: JACKPOT ---
        const jackpotGame = {
            pot: [],
            active: false,
            countdown: null,

            reset: () => {
                jackpotGame.pot = [];
                jackpotGame.active = false;
                if(jackpotGame.countdown) clearInterval(jackpotGame.countdown);
                jackpotGame.updateUI();
            },

            join: async () => {
                if(jackpotGame.active) return;
                const bet = parseFloat(document.getElementById('jp-bet').value);
                if(isNaN(bet) || bet < 10) return alert("Min bet is $10");
                if(!server.processBet(bet)) return alert("Insufficient Funds");

                document.getElementById('btn-jp-join').disabled = true;
                document.getElementById('btn-jp-join').innerText = "JOINED";
                
                // Add User
                jackpotGame.pot.push({ name: server.state.username, amount: bet, color: '#f59e0b', isUser: true });
                jackpotGame.updateUI();

                // Simulate Bots
                jackpotGame.active = true;
                const botNames = ["xX_Slayer_Xx", "GabeN", "TutiLover", "SkinFreak", "Donk"];
                
                let timer = 0;
                const timerEl = document.getElementById('jp-timer-fill');
                
                // Start Countdown
                jackpotGame.countdown = setInterval(() => {
                    timer += 1;
                    if(timerEl) timerEl.style.width = `${timer}%`;
                    if(timer >= 100) {
                        clearInterval(jackpotGame.countdown);
                        jackpotGame.spin();
                    }
                }, 50);

                // Random bots join
                const botCount = Math.floor(Math.random() * 3) + 1;
                for(let i=0; i<botCount; i++) {
                    await Utils.sleep(Math.random() * 1500 + 500);
                    const botBet = Math.floor(Math.random() * bet * 2) + 10;
                    const colors = ['#ef4444', '#3b82f6', '#10b981', '#a855f7'];
                    jackpotGame.pot.push({ 
                        name: botNames[Math.floor(Math.random()*botNames.length)], 
                        amount: botBet, 
                        color: colors[i % colors.length], 
                        isUser: false 
                    });
                    jackpotGame.updateUI();
                }
            },

            updateUI: () => {
                if(!document.getElementById('jp-players')) return;
                const total = jackpotGame.pot.reduce((a,b) => a + b.amount, 0);
                document.getElementById('jp-pot-total').innerText = ui.formatMoney(total);
                
                const list = document.getElementById('jp-players');
                list.innerHTML = jackpotGame.pot.map(p => `
                    <div class="flex items-center justify-between bg-black p-3 rounded border-l-4" style="border-color: ${p.color}">
                        <span class="font-bold text-white">${p.name}</span>
                        <span class="font-mono text-slate-400">${ui.formatMoney(p.amount)} (${((p.amount/total)*100).toFixed(1)}%)</span>
                    </div>
                `).join('');

                const userEntry = jackpotGame.pot.find(p => p.isUser);
                if(userEntry) {
                    const chance = (userEntry.amount / total) * 100;
                    document.getElementById('jp-chance').innerText = `Your Chance: ${chance.toFixed(2)}%`;
                }

                // Update Wheel Gradient
                if(total > 0) {
                    let gradient = [];
                    let currentDeg = 0;
                    jackpotGame.pot.forEach(p => {
                        const deg = (p.amount / total) * 360;
                        gradient.push(`${p.color} ${currentDeg}deg ${currentDeg + deg}deg`);
                        currentDeg += deg;
                    });
                    document.getElementById('jp-spinner').style.background = `conic-gradient(${gradient.join(', ')})`;
                }
            },

            spin: () => {
                const total = jackpotGame.pot.reduce((a,b) => a + b.amount, 0);
                // Determine winner
                let r = Math.random() * total;
                let accum = 0;
                let winner = null;
                let winningAngle = 0;

                for(let p of jackpotGame.pot) {
                    if(r >= accum && r < accum + p.amount) {
                        winner = p;
                        // Center of this segment
                        const startDeg = (accum / total) * 360;
                        const endDeg = ((accum + p.amount) / total) * 360;
                        // Target is meant to be at top (0deg). 
                        // We need to rotate the wheel so this segment is at top.
                        // Currently 0 is top. 
                        winningAngle = 360 - ((startDeg + endDeg) / 2);
                        break;
                    }
                    accum += p.amount;
                }

                const spinner = document.getElementById('jp-spinner');
                const finalRot = 3600 + winningAngle;
                spinner.style.transition = 'transform 6s cubic-bezier(0.1, 0, 0.05, 1)';
                spinner.style.transform = `rotate(${finalRot}deg)`;

                setTimeout(() => {
                    if(winner.isUser) {
                        const profit = total * 0.95; // 5% Tax
                        server.addWin(profit);
                        alert(`JACKPOT! You won ${ui.formatMoney(profit)} (after tax)`);
                    } else {
                        alert(`${winner.name} won the pot.`);
                    }
                    router.navigate('jackpot');
                }, 6500);
            }
        };

        // --- GAME LOGIC: CASES ---
        const game = {
            currentDrops: [],
            openCount: 1,
            fastMode: false,

            setCount: (n) => {
                game.openCount = n;
                [1,2,3].forEach(i => {
                    const btn = document.getElementById(`btn-c-${i}`);
                    if(i === n) btn.className = "count-btn bg-amber-600 text-black px-4 py-2 rounded-lg font-bold transition";
                    else btn.className = "count-btn bg-zinc-800 text-slate-400 px-4 py-2 rounded-lg font-bold transition hover:text-white";
                });
                const area = document.getElementById('spinners-area');
                if(area) {
                    area.innerHTML = '';
                    for(let i=0; i<n; i++) {
                        area.innerHTML += `
                            <div class="spinner-container relative">
                                <div class="spinner-overlay-left"></div><div class="spinner-overlay-right"></div><div class="center-line"></div>
                                <div class="items-strip" id="spinner-strip-${i}"></div>
                            </div>
                        `;
                        const cId = router.current === 'case' ? DB.cases.find(c=> document.querySelector('h1').innerText.includes(c.name.toUpperCase())).id : 'case_low';
                        game.generateStrip(DB.cases.find(c=>c.id===cId), `spinner-strip-${i}`);
                    }
                }
            },

            generateStrip: (caseObj, elementId) => {
                const strip = document.getElementById(elementId);
                if(!strip) return;
                let html = '';
                for(let i=0; i<80; i++) {
                    const item = caseObj.items[Math.floor(Math.random() * caseObj.items.length)];
                    html += `
                        <div class="w-[150px] h-[180px] flex-shrink-0 mx-1 bg-[#0f0f0f] border-b-2 rarity-${item.rarity} flex flex-col items-center justify-center rounded-lg relative overflow-hidden">
                            <div class="relative z-10 scale-90">${DB.renderItem(item)}</div>
                        </div>`;
                }
                strip.innerHTML = html;
            },

            startOpening: (caseId) => {
                const btn = document.getElementById('btn-spin');
                const err = document.getElementById('spin-error');
                const c = DB.cases.find(x => x.id === caseId);

                if(server.state.balance < (c.price * game.openCount)) {
                    err.innerText = "INSUFFICIENT FUNDS"; return;
                }

                btn.disabled = true; err.innerText = "";
                game.currentDrops = [];

                for(let i=0; i<game.openCount; i++) {
                    const res = server.openCase(caseId);
                    if(res.success) game.currentDrops.push(res.item);
                }

                if(game.fastMode) {
                    document.getElementById('fast-overlay').classList.remove('hidden');
                    setTimeout(() => {
                        game.showResults();
                        document.getElementById('fast-overlay').classList.add('hidden');
                        btn.disabled = false;
                        game.setCount(game.openCount);
                    }, 400);
                } else {
                    game.currentDrops.forEach((result, index) => {
                        const strip = document.getElementById(`spinner-strip-${index}`);
                        if(!strip) return;
                        
                        const cardWidth = 158; 
                        const landIndex = 60; 
                        const offset = (landIndex * cardWidth) - (strip.parentElement.offsetWidth / 2) + (150/2);
                        const jitter = Math.floor(Math.random() * 50) - 25;

                        const visItem = strip.children[landIndex];
                        visItem.innerHTML = `<div class="relative z-10 scale-110 drop-shadow-2xl">${DB.renderItem(result)}</div>`;
                        visItem.className = `w-[150px] h-[180px] flex-shrink-0 mx-1 bg-[#151515] border-b-4 rarity-${result.rarity} flex flex-col items-center justify-center rounded-lg relative overflow-hidden shadow-[0_0_30px_rgba(0,0,0,0.5)] z-20 transform scale-105`;

                        strip.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.05, 1)';
                        strip.style.transform = `translateX(-${offset + jitter}px)`;
                    });

                    setTimeout(() => {
                        game.showResults();
                        btn.disabled = false;
                        game.setCount(game.openCount);
                    }, 4500);
                }
            },

            showResults: () => {
                const grid = document.getElementById('drop-grid');
                grid.innerHTML = '';
                game.currentDrops.forEach(item => {
                    grid.innerHTML += `
                        <div class="bg-zinc-800 p-4 rounded-xl border border-zinc-700 flex flex-col items-center w-48 rarity-${item.rarity} relative">
                            <div class="w-full h-24 flex items-center justify-center mb-2">${DB.renderItem(item, "w-32 h-20")}</div>
                            <div class="text-sm font-bold text-white mb-1" style="color:var(--glow)">${item.name}</div>
                            <div class="text-xs font-mono text-amber-500 bg-black/50 px-2 py-1 rounded">${ui.formatMoney(item.price)}</div>
                        </div>
                    `;
                });
                ui.openModal('drop-modal');
                const content = document.getElementById('drop-content');
                content.classList.remove('scale-90', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            },

            sellAllDrops: () => {
                game.currentDrops.forEach(i => server.sellItem(i.uid));
                ui.closeModal('drop-modal');
                if(router.current === 'inventory') router.navigate('inventory');
            }
        };

        // --- GAME LOGIC: UPGRADER ---
        const upgrader = {
            source: null,
            target: null,
            winChance: 0,

            openSourceSelector: () => {
                const grid = document.getElementById('modal-source-grid');
                grid.innerHTML = '';
                if(!server.state.inventory.length) grid.innerHTML = '<p class="text-slate-500 col-span-full text-center">Empty Inventory</p>';
                server.state.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = `bg-zinc-800 p-2 rounded border border-zinc-700 cursor-pointer hover:border-amber-500 flex flex-col items-center`;
                    el.innerHTML = `${DB.renderItem(item, "w-20 h-14")}<span class="text-[10px] text-slate-300 truncate w-full text-center mt-1">${item.name}</span><span class="text-[10px] text-amber-500">${ui.formatMoney(item.price)}</span>`;
                    el.onclick = () => {
                        upgrader.source = item;
                        document.getElementById('modal-source').classList.add('hidden');
                        upgrader.updateUI();
                    };
                    grid.appendChild(el);
                });
                document.getElementById('modal-source').classList.remove('hidden');
            },

            openTargetSelector: () => {
                const grid = document.getElementById('modal-target-grid');
                grid.innerHTML = '';
                DB.getAllItems().sort((a,b) => b.price - a.price).forEach(item => {
                    const el = document.createElement('div');
                    el.className = `bg-zinc-800 p-2 rounded border border-zinc-700 cursor-pointer hover:border-amber-500 flex flex-col items-center`;
                    el.innerHTML = `${DB.renderItem(item, "w-20 h-14")}<span class="text-[10px] text-slate-300 truncate w-full text-center mt-1">${item.name}</span><span class="text-[10px] text-amber-500">${ui.formatMoney(item.price)}</span>`;
                    el.onclick = () => {
                        upgrader.target = item;
                        document.getElementById('modal-target').classList.add('hidden');
                        upgrader.updateUI();
                    };
                    grid.appendChild(el);
                });
                document.getElementById('modal-target').classList.remove('hidden');
            },

            updateUI: () => {
                if(upgrader.source) {
                    const s = document.getElementById('upg-source');
                    s.innerHTML = `${DB.renderItem(upgrader.source, "w-32 h-20")}<div class="text-sm font-bold text-white mt-2">${upgrader.source.name}</div><div class="text-xs text-amber-500 font-mono">${ui.formatMoney(upgrader.source.price)}</div>`;
                    s.className = "w-64 h-80 bg-zinc-800 border-2 border-amber-500 rounded-xl flex flex-col items-center justify-center cursor-pointer";
                    document.getElementById('upg-target').classList.remove('opacity-50', 'pointer-events-none');
                }

                if(upgrader.target) {
                    const t = document.getElementById('upg-target');
                    t.innerHTML = `${DB.renderItem(upgrader.target, "w-32 h-20")}<div class="text-sm font-bold text-white mt-2">${upgrader.target.name}</div><div class="text-xs text-amber-500 font-mono">${ui.formatMoney(upgrader.target.price)}</div>`;
                    t.className = "w-64 h-80 bg-zinc-800 border-2 border-amber-500 rounded-xl flex flex-col items-center justify-center cursor-pointer";
                }

                if(upgrader.source && upgrader.target) {
                    let chance = (upgrader.source.price / upgrader.target.price) * 0.9 * 100;
                    if(chance > 80) chance = 80;
                    
                    upgrader.winChance = chance;
                    const displayChance = chance < 0.01 ? "< 0.01%" : chance.toFixed(2) + '%';
                    
                    document.getElementById('win-chance').innerText = displayChance;
                    document.getElementById('wheel-spinner').style.setProperty('--angle', `${chance * 3.6}deg`);
                    document.getElementById('wheel-spinner').style.background = `conic-gradient(#f59e0b 0deg var(--angle), #222 var(--angle) 360deg)`;
                    
                    const btn = document.getElementById('btn-upgrade');
                    btn.disabled = false;
                    btn.classList.remove('bg-zinc-800', 'text-slate-600');
                    btn.classList.add('bg-amber-600', 'text-black');
                }
            },

            roll: () => {
                const btn = document.getElementById('btn-upgrade');
                btn.disabled = true;
                const spinner = document.getElementById('wheel-spinner');
                
                spinner.style.transition = 'none';
                spinner.style.transform = 'rotate(0deg)';

                const res = server.upgrade(upgrader.source.uid, upgrader.target.name);
                
                setTimeout(() => {
                    spinner.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.05, 1)';
                    const angleSize = upgrader.winChance * 3.6; 
                    let targetRotation = 3600; 

                    if (res.win) {
                        const safeBuffer = Math.min(5, angleSize / 2);
                        const rand = Math.random() * (angleSize - (safeBuffer*2)) + safeBuffer;
                        targetRotation += rand;
                    } else {
                        const safeBuffer = 5;
                        const loseZone = 360 - angleSize - (safeBuffer*2);
                        const rand = Math.random() * loseZone + angleSize + safeBuffer;
                        targetRotation += rand;
                    }

                    spinner.style.transform = `rotate(-${targetRotation}deg)`; 
                    
                    setTimeout(() => {
                        if(res.win) {
                            alert(`UPGRADE SUCCESS! You got ${res.item.name}`);
                        } else {
                            alert("UPGRADE FAILED. Item lost.");
                        }
                        upgrader.source = null; upgrader.target = null;
                        router.navigate('upgrader');
                    }, 4100);
                }, 50);
            }
        };

        // --- GAME LOGIC: CRASH ---
        const crashGame = {
            running: false,
            multiplier: 1.00,
            crashPoint: 0,
            bet: 0,
            cashedOut: false,
            canvas: null,
            ctx: null,

            init: () => {
                const canvas = document.getElementById('crash-canvas');
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                crashGame.canvas = canvas;
                crashGame.ctx = canvas.getContext('2d');
                crashGame.reset();
            },

            reset: () => {
                crashGame.running = false;
                crashGame.multiplier = 1.00;
                crashGame.cashedOut = false;
                document.getElementById('crash-multiplier').innerText = "1.00x";
                document.getElementById('crash-multiplier').classList.remove('text-red-500', 'text-emerald-500');
                document.getElementById('crash-multiplier').classList.add('text-white');
                document.getElementById('btn-crash-action').innerText = "PLACE BET";
                document.getElementById('btn-crash-action').className = "w-full bg-amber-600 hover:bg-amber-500 text-black font-black text-xl py-6 rounded-xl transition uppercase";
                document.getElementById('btn-crash-action').disabled = false;
                crashGame.drawGraph(0);
            },

            action: () => {
                if (!crashGame.running) {
                    const betInput = document.getElementById('crash-bet');
                    const amount = parseFloat(betInput.value);
                    if (isNaN(amount) || amount <= 0) return alert("Invalid bet");
                    
                    if(server.processBet(amount)) {
                        crashGame.bet = amount;
                        crashGame.startGame();
                    } else {
                        alert("Insufficient Funds");
                    }
                } else {
                    crashGame.doCashout();
                }
            },

            startGame: () => {
                crashGame.running = true;
                crashGame.crashPoint = crashGame.getCrashPoint();
                document.getElementById('btn-crash-action').innerText = "CASHOUT";
                document.getElementById('btn-crash-action').className = "w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black text-xl py-6 rounded-xl transition uppercase";
                
                let startTime = Date.now();
                
                const loop = () => {
                    if (!crashGame.running || router.current !== 'crash') return;
                    
                    const elapsed = (Date.now() - startTime) / 1000;
                    crashGame.multiplier = 1 + (0.06 * elapsed) + Math.pow(elapsed, 2) * 0.04; 

                    document.getElementById('crash-multiplier').innerText = crashGame.multiplier.toFixed(2) + 'x';
                    
                    if (!crashGame.cashedOut) {
                         const currentWin = (crashGame.bet * crashGame.multiplier).toFixed(2);
                         document.getElementById('crash-status').innerText = `PAYOUT: $${currentWin}`;
                         document.getElementById('crash-status').classList.remove('hidden');
                    }

                    if (crashGame.multiplier >= crashGame.crashPoint) {
                        crashGame.bust();
                    } else {
                        crashGame.drawGraph(elapsed);
                        requestAnimationFrame(loop);
                    }
                };
                requestAnimationFrame(loop);
            },

            doCashout: () => {
                if(!crashGame.running || crashGame.cashedOut) return;
                crashGame.cashedOut = true;
                const win = crashGame.bet * crashGame.multiplier;
                server.addWin(win);
                document.getElementById('btn-crash-action').innerText = "CASHED OUT";
                document.getElementById('btn-crash-action').disabled = true;
                document.getElementById('crash-multiplier').classList.add('text-emerald-500');
                document.getElementById('crash-status').innerText = `WON $${win.toFixed(2)}`;
            },

            bust: () => {
                crashGame.running = false;
                document.getElementById('crash-multiplier').innerText = `CRASHED @ ${crashGame.multiplier.toFixed(2)}x`;
                document.getElementById('crash-multiplier').classList.remove('text-white');
                document.getElementById('crash-multiplier').classList.add('text-red-500');
                document.getElementById('crash-status').classList.add('hidden');
                
                if (!crashGame.cashedOut) {
                    document.getElementById('btn-crash-action').innerText = "BUSTED";
                    document.getElementById('btn-crash-action').className = "w-full bg-red-600 text-white font-black text-xl py-6 rounded-xl transition uppercase cursor-not-allowed";
                }
                
                setTimeout(() => {
                    crashGame.reset();
                }, 3000);
            },

            getCrashPoint: () => {
                if (Math.random() < 0.03) return 1.00; 
                const r = Math.random();
                const crash = 0.99 / (1 - r);
                return Math.max(1.00, Math.min(crash, 10000));
            },

            drawGraph: (progress) => {
                const ctx = crashGame.ctx;
                const cvs = crashGame.canvas;
                ctx.clearRect(0, 0, cvs.width, cvs.height);

                ctx.beginPath();
                ctx.strokeStyle = '#f59e0b';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';

                const startX = 0;
                const startY = cvs.height;
                
                let x = Math.min(cvs.width, progress * 50); 
                let y = cvs.height - (Math.min(cvs.height, (crashGame.multiplier - 1) * 100));
                
                ctx.quadraticCurveTo(x/2, cvs.height, x, y);
                ctx.stroke();

                ctx.lineTo(x, cvs.height);
                ctx.lineTo(0, cvs.height);
                ctx.fillStyle = 'rgba(245, 158, 11, 0.1)';
                ctx.fill();
            }
        };

        // --- GAME LOGIC: MINES ---
        const minesGame = {
            active: false,
            bet: 0,
            minesCount: 3,
            grid: [], // 0 = safe, 1 = mine
            revealed: [],
            currentMult: 1.00,

            renderGrid: () => {
                const container = document.getElementById('mines-grid');
                container.innerHTML = '';
                for(let i=0; i<25; i++) {
                    const btn = document.createElement('button');
                    btn.className = "mine-tile w-full h-16 bg-zinc-800 rounded-lg border-b-4 border-zinc-700 flex items-center justify-center text-2xl relative overflow-hidden";
                    btn.id = `mine-${i}`;
                    btn.onclick = () => minesGame.clickTile(i);
                    container.appendChild(btn);
                }
            },

            startGame: () => {
                if(minesGame.active) return;
                
                const betInput = document.getElementById('mines-bet');
                const minesInput = document.getElementById('mines-count');
                const amount = parseFloat(betInput.value);
                const count = parseInt(minesInput.value);

                if(isNaN(amount) || amount <= 0) return alert("Invalid bet");
                if(isNaN(count) || count < 1 || count > 24) return alert("Invalid mines (1-24)");

                if(server.processBet(amount)) {
                    minesGame.bet = amount;
                    minesGame.minesCount = count;
                    minesGame.active = true;
                    minesGame.revealed = Array(25).fill(false);
                    minesGame.currentMult = 1.00;
                    
                    minesGame.grid = Array(25).fill(0);
                    let placed = 0;
                    while(placed < count) {
                        const idx = Math.floor(Math.random() * 25);
                        if(minesGame.grid[idx] === 0) {
                            minesGame.grid[idx] = 1;
                            placed++;
                        }
                    }

                    minesGame.renderGrid();
                    document.getElementById('btn-mines-start').classList.add('hidden');
                    document.getElementById('btn-mines-cashout').classList.remove('hidden');
                    document.getElementById('btn-mines-cashout').innerText = "CASHOUT $0.00";
                    minesGame.updateStats();
                } else {
                    alert("Insufficient Funds");
                }
            },

            clickTile: (idx) => {
                if(!minesGame.active || minesGame.revealed[idx]) return;

                const tile = document.getElementById(`mine-${idx}`);
                
                if(minesGame.grid[idx] === 1) {
                    tile.classList.add('bg-red-500', 'border-red-700');
                    tile.innerHTML = '<i data-lucide="bomb" class="text-white animate-bounce"></i>';
                    minesGame.gameOver(false);
                } else {
                    minesGame.revealed[idx] = true;
                    tile.classList.add('bg-zinc-700', 'border-zinc-600', 'revealed');
                    tile.innerHTML = '<i data-lucide="gem" class="text-emerald-400 pop-in"></i>';
                    
                    const totalTiles = 25;
                    const safeTiles = 25 - minesGame.minesCount;
                    const revealedCount = minesGame.revealed.filter(Boolean).length;
                    
                    const remainingTotal = 25 - (revealedCount - 1);
                    const remainingSafe = safeTiles - (revealedCount - 1);
                    const stepMult = remainingTotal / remainingSafe;
                    
                    minesGame.currentMult *= stepMult;
                    minesGame.currentMult *= 0.99;

                    if(revealedCount === safeTiles) {
                        minesGame.cashout(); 
                    } else {
                        minesGame.updateStats();
                    }
                }
                lucide.createIcons();
            },

            updateStats: () => {
                const profit = (minesGame.bet * minesGame.currentMult) - minesGame.bet;
                const total = minesGame.bet * minesGame.currentMult;
                
                document.getElementById('mines-profit').innerText = ui.formatMoney(profit > 0 ? profit : 0);
                document.getElementById('btn-mines-cashout').innerText = `CASHOUT ${ui.formatMoney(total)}`;
                
                const revealedCount = minesGame.revealed.filter(Boolean).length;
                const remainingTotal = 25 - revealedCount;
                const remainingSafe = (25 - minesGame.minesCount) - revealedCount;
                const nextStep = (remainingTotal / remainingSafe) * 0.99;
                
                document.getElementById('mines-next-mult').innerText = (minesGame.currentMult * nextStep).toFixed(2) + 'x';
            },

            cashout: () => {
                if(!minesGame.active) return;
                const win = minesGame.bet * minesGame.currentMult;
                server.addWin(win);
                minesGame.gameOver(true);
            },

            gameOver: (win) => {
                minesGame.active = false;
                minesGame.grid.forEach((isMine, i) => {
                    const tile = document.getElementById(`mine-${i}`);
                    if(isMine) {
                        tile.innerHTML = '<i data-lucide="bomb" class="text-white/50"></i>';
                        if(!win) tile.classList.add('bg-red-900/50');
                    } else if(!minesGame.revealed[i]) {
                        tile.classList.add('opacity-50');
                    }
                });

                document.getElementById('btn-mines-start').classList.remove('hidden');
                document.getElementById('btn-mines-cashout').classList.add('hidden');
                lucide.createIcons();
                
                if(win) alert(`You won ${ui.formatMoney(minesGame.bet * minesGame.currentMult)}!`);
            }
        };

        server.subscribe(ui.renderNav);
        router.navigate('home');
        lucide.createIcons();
    </script>
</body>
</html>
